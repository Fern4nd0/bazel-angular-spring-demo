openapi: 3.0.3
info:
  title: Users API
  version: 1.0.0
  description: API for user management (CRUD + search).
servers:
  - url: https://api.your-domain.com/v1

tags:
  - name: Users
    description: User operations

security:
  - BearerAuth: [ ]

paths:
  /users:
    get:
      tags: [ Users ]
      summary: List users
      description: Returns a paginated list of users with optional filters.
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - $ref: "#/components/parameters/Sort"
        - name: status
          in: query
          description: Filter by user status
          schema:
            $ref: "#/components/schemas/UserStatus"
        - name: role
          in: query
          description: Filter by role
          schema:
            type: string
            example: admin
      responses:
        "200":
          description: Users list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      tags: [ Users ]
      summary: Create user
      description: Creates a new user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
            examples:
              example:
                value:
                  email: "ana@company.com"
                  firstName: "Ana"
                  lastName: "Garcia"
                  role: "user"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Conflict (e.g., email already exists)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                code: "CONFLICT"
                message: "Email is already registered."
        "500":
          $ref: "#/components/responses/ServerError"

  /users/search:
    get:
      tags: [ Users ]
      summary: Search users
      description: Searches users by text (email, first name, last name). Returns paginated results.
      parameters:
        - name: q
          in: query
          required: true
          description: Search text (2+ characters recommended)
          schema:
            type: string
            example: "ana"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /users/{userId}:
    get:
      tags: [ Users ]
      summary: Get user details
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

    patch:
      tags: [ Users ]
      summary: Partially update a user
      description: Updates only the fields provided in the request body.
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
            examples:
              example:
                value:
                  firstName: "Ana Maria"
                  status: "active"
      responses:
        "200":
          description: User updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

    delete:
      tags: [ Users ]
      summary: Delete user
      description: Deletes (or deactivates) a user by ID.
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        "204":
          description: Deleted successfully (no content)
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      description: User ID
      schema:
        type: string
        example: "usr_123456"

    Page:
      name: page
      in: query
      required: false
      description: Page number (1..N)
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSize:
      name: pageSize
      in: query
      required: false
      description: Page size
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 20

    Sort:
      name: sort
      in: query
      required: false
      description: Sorting "field:asc|desc" (e.g., createdAt:desc)
      schema:
        type: string
        example: "createdAt:desc"

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: "BAD_REQUEST"
            message: "Invalid parameters."
            details:
              - field: "email"
                issue: "Invalid format"

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: "UNAUTHORIZED"
            message: "Missing or invalid token."

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: "NOT_FOUND"
            message: "User not found."

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: "INTERNAL_ERROR"
            message: "Unexpected error occurred."

  schemas:
    UserStatus:
      type: string
      description: User status
      enum: [ active, inactive, blocked ]
      example: active

    User:
      type: object
      required: [ id, email, firstName, lastName, status, role, createdAt, updatedAt ]
      properties:
        id:
          type: string
          example: "usr_123456"
        email:
          type: string
          format: email
          example: "ana@company.com"
        firstName:
          type: string
          example: "Ana"
        lastName:
          type: string
          example: "Garcia"
        role:
          type: string
          description: User role (depends on your authorization model)
          example: "user"
        status:
          $ref: "#/components/schemas/UserStatus"
        phone:
          type: string
          nullable: true
          example: "+34 600 123 123"
        metadata:
          type: object
          additionalProperties: true
          description: Optional untyped extra fields
          example:
            locale: "en-US"
            marketingOptIn: false
        createdAt:
          type: string
          format: date-time
          example: "2026-01-07T10:15:30Z"
        updatedAt:
          type: string
          format: date-time
          example: "2026-01-07T10:20:00Z"

    UserCreate:
      type: object
      required: [ email, firstName, lastName ]
      properties:
        email:
          type: string
          format: email
        firstName:
          type: string
          minLength: 1
        lastName:
          type: string
          minLength: 1
        role:
          type: string
          default: "user"
        phone:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true

    UserUpdate:
      type: object
      description: Updatable fields (all optional)
      properties:
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        role:
          type: string
        status:
          $ref: "#/components/schemas/UserStatus"
        phone:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true

    Pagination:
      type: object
      required: [ page, pageSize, totalItems, totalPages ]
      properties:
        page:
          type: integer
          example: 1
        pageSize:
          type: integer
          example: 20
        totalItems:
          type: integer
          example: 120
        totalPages:
          type: integer
          example: 6

    UserListResponse:
      type: object
      required: [ items, pagination ]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/User"
        pagination:
          $ref: "#/components/schemas/Pagination"

    ErrorDetail:
      type: object
      properties:
        field:
          type: string
          example: "email"
        issue:
          type: string
          example: "Invalid format"

    Error:
      type: object
      required: [ code, message ]
      properties:
        code:
          type: string
          example: "BAD_REQUEST"
        message:
          type: string
          example: "Invalid parameters."
        details:
          type: array
          items:
            $ref: "#/components/schemas/ErrorDetail"
